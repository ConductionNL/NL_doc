apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: nldoc
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  project: nldoc
  sources:
    # RabbitMQ cluster (requires rabbitmq-operator to be installed)
    - repoURL: https://github.com/ConductionNL/NL_doc.git
      targetRevision: main
      path: gitops/infra/rabbitmq

    # MinIO for S3 storage
    - repoURL: https://charts.min.io
      chart: minio
      targetRevision: "5.2.0"
      helm:
        releaseName: minio
        values: |
          mode: standalone
          replicas: 1
          persistence:
            enabled: true
            size: 20Gi
          resources:
            requests:
              memory: 512Mi
          existingSecret: minio-credentials
          buckets:
            - name: nldoc
              policy: none

    # editor-app chart
    - repoURL: https://gitlab.com/api/v4/projects/68643351/packages/helm/stable
      chart: editor-app
      targetRevision: "*"
      helm:
        releaseName: editor-app
        values: |
          ingress:
            enabled: true
            tls: true
            hostname: editor.nldoc.commonground.nu
            annotations:
              cert-manager.io/cluster-issuer: letsencrypt-prod
              nginx.ingress.kubernetes.io/auth-type: "basic"
              nginx.ingress.kubernetes.io/auth-secret: "nldoc-basic-auth"
              nginx.ingress.kubernetes.io/auth-realm: "Authentication Required"
          extraEnvVars:
            - name: API_URL
              value: https://api.nldoc.commonground.nu

    # api chart
    - repoURL: https://gitlab.com/api/v4/projects/68640094/packages/helm/stable
      chart: api
      targetRevision: "*"
      helm:
        releaseName: api
        values: |
          ingress:
            enabled: true
            tls: true
            hostname: api.nldoc.commonground.nu
            annotations:
              cert-manager.io/cluster-issuer: letsencrypt-prod
              nginx.ingress.kubernetes.io/auth-type: "basic"
              nginx.ingress.kubernetes.io/auth-secret: "nldoc-basic-auth"
              nginx.ingress.kubernetes.io/auth-realm: "Authentication Required"
          amqp:
            queue:
              events: results
          extraEnvVars:
            - name: AMQP_HOST
              value: rabbitmq.nldoc.svc.cluster.local
            - name: AMQP_USERNAME
              valueFrom:
                secretKeyRef:
                  name: rabbitmq-default-user
                  key: username
            - name: AMQP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: rabbitmq-default-user
                  key: password
            - name: S3_HOST
              value: minio.nldoc.svc.cluster.local
            - name: S3_PORT
              value: "9000"
            - name: S3_USE_SSL
              value: "false"
            - name: S3_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: rootUser
            - name: S3_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: rootPassword

    # kimi chart (minimal config)
    - repoURL: https://gitlab.com/api/v4/projects/68736728/packages/helm/stable
      chart: kimi
      targetRevision: "*"
      helm:
        releaseName: kimi
        values: |
          postgresql:
            host: nldoc-postgres.nldoc.svc.cluster.local
            port: 5432
            db: nldoc
            useSSL: "false"
          extraEnvVars:
            - name: AMQP_HOST
              value: rabbitmq.nldoc.svc.cluster.local
            - name: AMQP_USERNAME
              valueFrom:
                secretKeyRef:
                  name: rabbitmq-default-user
                  key: username
            - name: AMQP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: rabbitmq-default-user
                  key: password
            - name: S3_HOST
              value: minio.nldoc.svc.cluster.local
            - name: S3_PORT
              value: "9000"
            - name: S3_USE_SSL
              value: "false"
            - name: S3_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: rootUser
            - name: S3_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: rootPassword
            - name: POSTGRESQL_USERNAME
              valueFrom:
                secretKeyRef:
                  name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                  key: username
            - name: POSTGRESQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                  key: password
          stations:
            "document-source":
              replicaCount: 1
            "pdf-pages":
              replicaCount: 1
            "page-content":
              replicaCount: 1
          workers:
            "elixir-workers":
              replicaCount: 1
            "pdf-page":
              replicaCount: 1
            "page-content":
              replicaCount: 1

    # PostgreSQL cluster (Zalando)
    - repoURL: git@github.com:ConductionNL/gitops-postgres.git
      targetRevision: main
      path: nldoc-postgres

  destination:
    server: https://kubernetes.default.svc
    namespace: nldoc
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
