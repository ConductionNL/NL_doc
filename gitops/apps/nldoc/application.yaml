apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: nldoc
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  project: nldoc
  sources:
    # RabbitMQ cluster (requires rabbitmq-operator to be installed)
    - repoURL: git@github.com:ConductionNL/NL_doc.git
      targetRevision: main
      path: gitops/infra/rabbitmq

    # MinIO for S3 storage
    - repoURL: https://charts.min.io
      chart: minio
      targetRevision: "5.2.0"
      helm:
        releaseName: minio
        values: |
          mode: standalone
          replicas: 1
          persistence:
            enabled: true
            existingClaim: minio
            storageClass: default
            size: 20Gi
          resources:
            requests:
              memory: 512Mi
          existingSecret: minio-credentials
          buckets:
            - name: nldoc
              policy: none

    # editor-app manifests (vendored)
    - repoURL: git@github.com:ConductionNL/NL_doc.git
      targetRevision: main
      path: gitops/apps/nldoc/editor-manifests

    # api manifests (vendored)
    - repoURL: git@github.com:ConductionNL/NL_doc.git
      targetRevision: main
      path: gitops/apps/nldoc/api-manifests

    # PostgreSQL cluster (Zalando)
    - repoURL: git@github.com:ConductionNL/gitops-postgres.git
      targetRevision: main
      path: nldoc-postgres

  destination:
    server: https://kubernetes.default.svc
    namespace: nldoc
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - Replace=true
  ignoreDifferences:
    - group: ""
      kind: Pod
    - group: apps
      kind: ReplicaSet
    - group: ""
      kind: PersistentVolumeClaim
      jsonPointers:
        - /spec
