apiVersion: v1
kind: List
items:
# Station: document-source
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-station-document-source
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: station.document-source
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: station.document-source
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: station.document-source
      spec:
        serviceAccountName: kimi-station--document-source
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: station
          image: registry.gitlab.com/logius/nldoc/worker/stations:13.0.1
          imagePullPolicy: IfNotPresent
          env:
          - name: NODE_TLS_REJECT_UNAUTHORIZED
            value: "0"
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: STATION_CONFIGURATION
            value: |
              {"input":{"type":"document"},"output":{"attribute":{"name":"source","type":"file"},"type":"output"},"workerResult":"fileWorkerResult"}
          - name: POSTGRES_HOST
            value: nldoc-postgres.nldoc.svc.cluster.local
          - name: POSTGRES_PORT
            value: "5432"
          - name: POSTGRES_DB
            value: nldoc
          - name: POSTGRES_USER
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          - name: POSTGRES_SCHEMA
            value: public
          - name: POSTGRES_SSL
            value: require
          - name: PGSSLMODE
            value: require
          - name: POSTGRES_POOL_SIZE
            value: "20"
          - name: POSTGRESQL_USERNAME
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRESQL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 150m
              memory: 192Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Worker: document-mimetype-from-header
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-worker-document-mimetype-from-header
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: worker.document-mimetype-from-header
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: worker.document-mimetype-from-header
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: worker.document-mimetype-from-header
      spec:
        serviceAccountName: kimi-worker--page-content
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: worker
          image: ghcr.io/conductionnl/nldoc-worker-document-mimetype-from-header:latest
          imagePullPolicy: Always
          env:
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 150m
              memory: 192Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Worker: pdf-nldocspec
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-worker-pdf-nldocspec
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: worker.pdf-nldocspec
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: worker.pdf-nldocspec
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: worker.pdf-nldocspec
      spec:
        serviceAccountName: kimi-worker--pdf-page
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: worker
          image: ghcr.io/conductionnl/nldoc-worker-pdf-nldocspec:latest
          imagePullPolicy: Always
          env:
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: S3_REGION
            value: us-east-1
          - name: S3_HOST
            value: minio
          - name: S3_PORT
            value: "9000"
          - name: S3_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: minio-credentials
                key: rootUser
          - name: S3_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: minio-credentials
                key: rootPassword
          - name: S3_USE_SSL
            value: "false"
          - name: S3_SCHEME
            value: http
          - name: S3_FORCE_PATH_STYLE
            value: "true"
          - name: POSTGRESQL_USERNAME
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRESQL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Worker: document-source (consumes station jobs and dispatches pipeline)
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-worker-document-source
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: worker.document-source
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: worker.document-source
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: worker.document-source
      spec:
        serviceAccountName: kimi-worker--page-content
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: worker
          image: python:3.11-slim
          imagePullPolicy: IfNotPresent
          command: ["sh", "-c", "pip install -q pika minio && python -u /app/app.py"]
          env:
          - name: HOME
            value: /tmp
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: S3_REGION
            value: us-east-1
          - name: S3_HOST
            value: minio
          - name: S3_PORT
            value: "9000"
          - name: S3_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: minio-credentials
                key: rootUser
          - name: S3_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: minio-credentials
                key: rootPassword
          - name: S3_USE_SSL
            value: "false"
          - name: S3_SCHEME
            value: http
          - name: S3_FORCE_PATH_STYLE
            value: "true"
          - name: POSTGRESQL_USERNAME
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRESQL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 150m
              memory: 192Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
          - name: code
            mountPath: /app
        volumes:
        - name: tmp
          emptyDir: {}
        - name: code
          configMap:
            name: document-source-shim-code

# Station: spec-html
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-station-spec-html
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: station.spec-html
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: station.spec-html
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: station.spec-html
      spec:
        serviceAccountName: kimi-station--page-content
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: station
          image: registry.gitlab.com/logius/nldoc/worker/stations:13.0.1
          imagePullPolicy: IfNotPresent
          env:
          - name: NODE_TLS_REJECT_UNAUTHORIZED
            value: "0"
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: STATION_CONFIGURATION
            value: |
              {"input":{"type":"spec"},"output":{"type":"html"},"workerResult":"fileWorkerResult"}
          - name: POSTGRES_HOST
            value: nldoc-postgres.nldoc.svc.cluster.local
          - name: POSTGRES_PORT
            value: "5432"
          - name: POSTGRES_DB
            value: nldoc
          - name: POSTGRES_USER
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          - name: POSTGRES_SCHEMA
            value: public
          - name: POSTGRES_SSL
            value: require
          - name: PGSSLMODE
            value: require
          - name: POSTGRES_POOL_SIZE
            value: "20"
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 150m
              memory: 192Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Station: spec-tiptap
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-station-spec-tiptap
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: station.spec-tiptap
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: station.spec-tiptap
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: station.spec-tiptap
      spec:
        serviceAccountName: kimi-station--page-content
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: station
          image: registry.gitlab.com/logius/nldoc/worker/stations:13.0.1
          imagePullPolicy: IfNotPresent
          env:
          - name: NODE_TLS_REJECT_UNAUTHORIZED
            value: "0"
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: STATION_CONFIGURATION
            value: |
              {"input":{"type":"spec"},"output":{"type":"tiptap"},"workerResult":"fileWorkerResult"}
          - name: POSTGRES_HOST
            value: nldoc-postgres.nldoc.svc.cluster.local
          - name: POSTGRES_PORT
            value: "5432"
          - name: POSTGRES_DB
            value: nldoc
          - name: POSTGRES_USER
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          - name: POSTGRES_SCHEMA
            value: public
          - name: POSTGRES_SSL
            value: require
          - name: PGSSLMODE
            value: require
          - name: POSTGRES_POOL_SIZE
            value: "20"
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 150m
              memory: 192Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Worker: pdf-pdfmetadata
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-worker-pdf-pdfmetadata
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: worker.pdf-pdfmetadata
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: worker.pdf-pdfmetadata
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: worker.pdf-pdfmetadata
      spec:
        serviceAccountName: kimi-worker--pdf-page
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: worker
          image: registry.gitlab.com/logius/nldoc/worker/pdf-metadata:4.0.0
          imagePullPolicy: IfNotPresent
          env:
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: S3_REGION
            value: us-east-1
          - name: S3_HOST
            value: minio
          - name: S3_PORT
            value: "9000"
          - name: S3_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: minio-credentials
                key: rootUser
          - name: S3_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: minio-credentials
                key: rootPassword
          - name: S3_USE_SSL
            value: "false"
          - name: S3_SCHEME
            value: http
          - name: S3_FORCE_PATH_STYLE
            value: "true"
          - name: POSTGRESQL_USERNAME
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRESQL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 150m
              memory: 192Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Station: pdf-pages
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-station-pdf-pages
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: station.pdf-pages
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: station.pdf-pages
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: station.pdf-pages
      spec:
        serviceAccountName: kimi-station--pdf-pages
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: station
          image: registry.gitlab.com/logius/nldoc/worker/stations:13.0.1
          imagePullPolicy: IfNotPresent
          env:
          - name: NODE_TLS_REJECT_UNAUTHORIZED
            value: "0"
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: STATION_CONFIGURATION
            value: |
              {"input":{"requiredAttributes":[{"behavior":"await_all","name":"pageCount"}],"type":"pdf"},"output":{"split":{"countAttribute":"pageCount","entityType":"page","indexing":"one-based"},"type":"split"}}
          - name: POSTGRES_HOST
            value: nldoc-postgres.nldoc.svc.cluster.local
          - name: POSTGRES_PORT
            value: "5432"
          - name: POSTGRES_DB
            value: nldoc
          - name: POSTGRES_USER
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          - name: POSTGRES_SCHEMA
            value: public
          - name: POSTGRES_SSL
            value: require
          - name: PGSSLMODE
            value: require
          - name: POSTGRES_POOL_SIZE
            value: "20"
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 150m
              memory: 192Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Station: pdf-pdfmetadata
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-station-pdf-pdfmetadata
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: station.pdf-pdfmetadata
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: station.pdf-pdfmetadata
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: station.pdf-pdfmetadata
      spec:
        serviceAccountName: kimi-station--pdf-pdfmetadata
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: station
          image: registry.gitlab.com/logius/nldoc/worker/stations:13.0.1
          imagePullPolicy: IfNotPresent
          env:
          - name: NODE_TLS_REJECT_UNAUTHORIZED
            value: "0"
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: STATION_CONFIGURATION
            value: |
              {"input":{"type":"pdf"},"output":{"type":"pdfMetadata"},"workerResult":"pdfMetadataWorkerResult"}
          - name: POSTGRES_HOST
            value: nldoc-postgres.nldoc.svc.cluster.local
          - name: POSTGRES_PORT
            value: "5432"
          - name: POSTGRES_DB
            value: nldoc
          - name: POSTGRES_USER
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          - name: POSTGRES_SCHEMA
            value: public
          - name: POSTGRES_SSL
            value: require
          - name: PGSSLMODE
            value: require
          - name: POSTGRES_POOL_SIZE
            value: "20"
          - name: S3_HOST
            value: minio.nldoc.svc.cluster.local
          - name: S3_PORT
            value: "9000"
          - name: S3_BUCKET_NAME
            value: files
          - name: S3_USE_SSL
            value: "false"
          - name: S3_SCHEME
            value: http
          - name: S3_FORCE_PATH_STYLE
            value: "true"
          - name: POSTGRESQL_USERNAME
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRESQL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 150m
              memory: 192Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Station: pdf-folio
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-station-pdf-folio
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: station.pdf-folio
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: station.pdf-folio
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: station.pdf-folio
      spec:
        serviceAccountName: kimi-station--pdf-folio
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: station
          image: registry.gitlab.com/logius/nldoc/worker/stations:13.0.1
          imagePullPolicy: IfNotPresent
          env:
          - name: NODE_TLS_REJECT_UNAUTHORIZED
            value: "0"
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: STATION_CONFIGURATION
            value: |
              {"input":{"aggregation":{"countAttribute":"pageCount","indexing":"one-based"},"requiredAttributes":[{"behavior":"await_all","name":"pageImage"}],"type":"pdf"},"output":{"type":"folio"}}
          - name: POSTGRES_HOST
            value: nldoc-postgres.nldoc.svc.cluster.local
          - name: POSTGRES_PORT
            value: "5432"
          - name: POSTGRES_DB
            value: nldoc
          - name: POSTGRES_USER
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          - name: POSTGRES_SCHEMA
            value: public
          - name: POSTGRES_SSL
            value: require
          - name: PGSSLMODE
            value: require
          - name: POSTGRES_POOL_SIZE
            value: "20"
          - name: S3_HOST
            value: minio.nldoc.svc.cluster.local
          - name: S3_PORT
            value: "9000"
          - name: S3_BUCKET_NAME
            value: files
          - name: S3_USE_SSL
            value: "false"
          - name: S3_SCHEME
            value: http
          - name: S3_FORCE_PATH_STYLE
            value: "true"
          - name: POSTGRESQL_USERNAME
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRESQL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 150m
              memory: 192Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Station: folio-spec
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-station-folio-spec
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: station.folio-spec
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: station.folio-spec
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: station.folio-spec
      spec:
        serviceAccountName: kimi-station--folio-spec
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: station
          image: registry.gitlab.com/logius/nldoc/worker/stations:13.0.1
          imagePullPolicy: IfNotPresent
          env:
          - name: NODE_TLS_REJECT_UNAUTHORIZED
            value: "0"
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: STATION_CONFIGURATION
            value: |
              {"input":{"aggregation":{"countAttribute":"pageCount","indexing":"one-based"},"requiredAttributes":[],"type":"folio"},"output":{"type":"spec"},"workerResult":"fileWorkerResult"}
          - name: POSTGRES_HOST
            value: nldoc-postgres.nldoc.svc.cluster.local
          - name: POSTGRES_PORT
            value: "5432"
          - name: POSTGRES_DB
            value: nldoc
          - name: POSTGRES_USER
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          - name: POSTGRES_SCHEMA
            value: public
          - name: POSTGRES_SSL
            value: require
          - name: PGSSLMODE
            value: require
          - name: POSTGRES_POOL_SIZE
            value: "20"
          - name: S3_HOST
            value: minio.nldoc.svc.cluster.local
          - name: S3_PORT
            value: "9000"
          - name: S3_BUCKET_NAME
            value: files
          - name: S3_USE_SSL
            value: "false"
          - name: S3_SCHEME
            value: http
          - name: S3_FORCE_PATH_STYLE
            value: "true"
          - name: POSTGRESQL_USERNAME
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRESQL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 150m
              memory: 192Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Station: page-content
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-station-page-content
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: station.page-content
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: station.page-content
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: station.page-content
      spec:
        serviceAccountName: kimi-station--page-content
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: station
          image: registry.gitlab.com/logius/nldoc/worker/stations:13.0.1
          imagePullPolicy: IfNotPresent
          env:
          - name: NODE_TLS_REJECT_UNAUTHORIZED
            value: "0"
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: STATION_CONFIGURATION
            value: |
              {"input":{"parentType":"folio","requiredAttributes":[{"behavior":"await_all","name":"pageImage"},{"behavior":"await_all","name":"interpretedContent"},{"behavior":"await_all","name":"regions"}],"type":"page"},"output":{"attribute":{"name":"content","type":"array"},"type":"attribute"},"workerResult":"fileWorkerResult"}
          - name: POSTGRES_HOST
            value: nldoc-postgres.nldoc.svc.cluster.local
          - name: POSTGRES_PORT
            value: "5432"
          - name: POSTGRES_DB
            value: nldoc
          - name: POSTGRES_USER
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          - name: POSTGRES_SCHEMA
            value: public
          - name: POSTGRES_SSL
            value: require
          - name: PGSSLMODE
            value: require
          - name: POSTGRES_POOL_SIZE
            value: "20"
          - name: POSTGRESQL_USERNAME
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRESQL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 150m
              memory: 192Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Worker: pdf-page
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-worker-pdf-page
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: worker.pdf-page
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: worker.pdf-page
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: worker.pdf-page
      spec:
        serviceAccountName: kimi-worker--pdf-page
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: worker
          image: registry.gitlab.com/logius/nldoc/worker/pdf-pages:2.0.0
          imagePullPolicy: IfNotPresent
          env:
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: S3_REGION
            value: us-east-1
          - name: S3_HOST
            value: minio
          - name: S3_PORT
            value: "9000"
          - name: S3_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: minio-credentials
                key: rootUser
          - name: S3_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: minio-credentials
                key: rootPassword
          - name: S3_USE_SSL
            value: "false"
          - name: S3_SCHEME
            value: http
          - name: S3_FORCE_PATH_STYLE
            value: "true"
          - name: POSTGRESQL_USERNAME
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRESQL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 150m
              memory: 192Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Worker: page-content
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-worker-page-content
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: worker.page-content
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: worker.page-content
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: worker.page-content
      spec:
        serviceAccountName: kimi-worker--page-content
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: worker
          image: registry.gitlab.com/logius/nldoc/worker/page-content:3.0.0
          imagePullPolicy: IfNotPresent
          env:
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: S3_REGION
            value: us-east-1
          - name: S3_HOST
            value: minio
          - name: S3_PORT
            value: "9000"
          - name: S3_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: minio-credentials
                key: rootUser
          - name: S3_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: minio-credentials
                key: rootPassword
          - name: S3_USE_SSL
            value: "false"
          - name: S3_SCHEME
            value: http
          - name: S3_FORCE_PATH_STYLE
            value: "true"
          - name: POSTGRESQL_USERNAME
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRESQL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 150m
              memory: 192Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Worker: elixir-workers (orchestrates PDF/spec flow)
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-worker-elixir-workers
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: worker.elixir-workers
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: worker.elixir-workers
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: worker.elixir-workers
      spec:
        serviceAccountName: kimi-worker--elixir-workers
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: worker
          image: registry.gitlab.com/logius/nldoc/worker/nldoc_worker:5.2.1
          imagePullPolicy: IfNotPresent
          env:
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: S3_REGION
            value: us-east-1
          - name: S3_HOST
            value: minio
          - name: S3_PORT
            value: "9000"
          - name: S3_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: minio-credentials
                key: rootUser
          - name: S3_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: minio-credentials
                key: rootPassword
          - name: S3_USE_SSL
            value: "false"
          - name: S3_SCHEME
            value: http
          - name: POSTGRESQL_USERNAME
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRESQL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          resources:
            requests:
              cpu: 200m
              memory: 512Mi
            limits:
              cpu: "1"
              memory: 1Gi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Station: page-image
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-station-page-image
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: station.page-image
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: station.page-image
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: station.page-image
      spec:
        serviceAccountName: kimi-station--page-image
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: station
          image: registry.gitlab.com/logius/nldoc/worker/stations:13.0.1
          imagePullPolicy: IfNotPresent
          env:
          - name: NODE_TLS_REJECT_UNAUTHORIZED
            value: "0"
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: STATION_CONFIGURATION
            value: |
              {"input":{"parentType":"folio","type":"page"},"output":{"attribute":{"name":"pageImage","type":"file"},"type":"attribute"},"workerResult":"fileWorkerResult"}
          - name: POSTGRES_HOST
            value: nldoc-postgres.nldoc.svc.cluster.local
          - name: POSTGRES_PORT
            value: "5432"
          - name: POSTGRES_DB
            value: nldoc
          - name: POSTGRES_USER
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          - name: POSTGRES_SCHEMA
            value: public
          - name: POSTGRES_SSL
            value: require
          - name: PGSSLMODE
            value: require
          - name: POSTGRES_POOL_SIZE
            value: "20"
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 150m
              memory: 192Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Station: page-regions
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-station-page-regions
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: station.page-regions
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: station.page-regions
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: station.page-regions
      spec:
        serviceAccountName: kimi-station--page-regions
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: station
          image: registry.gitlab.com/logius/nldoc/worker/stations:13.0.1
          imagePullPolicy: IfNotPresent
          env:
          - name: NODE_TLS_REJECT_UNAUTHORIZED
            value: "0"
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: STATION_CONFIGURATION
            value: |
              {"input":{"parentType":"folio","type":"page"},"output":{"attribute":{"name":"regions","type":"array"},"type":"attribute"},"workerResult":"fileWorkerResult"}
          - name: POSTGRES_HOST
            value: nldoc-postgres.nldoc.svc.cluster.local
          - name: POSTGRES_PORT
            value: "5432"
          - name: POSTGRES_DB
            value: nldoc
          - name: POSTGRES_USER
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          - name: POSTGRES_SCHEMA
            value: public
          - name: POSTGRES_SSL
            value: require
          - name: PGSSLMODE
            value: require
          - name: POSTGRES_POOL_SIZE
            value: "20"
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 150m
              memory: 192Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Worker: page-regions-image-processing
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-worker-page-regions-image-processing
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: worker.page-regions-image-processing
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: worker.page-regions-image-processing
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: worker.page-regions-image-processing
      spec:
        serviceAccountName: kimi-worker--page-regions-image-processing
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: worker
          image: registry.gitlab.com/logius/nldoc/worker/page-regions-image-processing:3.0.0
          imagePullPolicy: IfNotPresent
          env:
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: S3_REGION
            value: us-east-1
          - name: S3_HOST
            value: minio
          - name: S3_PORT
            value: "9000"
          - name: S3_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: minio-credentials
                key: rootUser
          - name: S3_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: minio-credentials
                key: rootPassword
          - name: S3_USE_SSL
            value: "false"
          - name: S3_SCHEME
            value: http
          - name: S3_FORCE_PATH_STYLE
            value: "true"
          - name: POSTGRESQL_USERNAME
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRESQL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 150m
              memory: 192Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Worker: page-regions-yolo
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-worker-page-regions-yolo
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: worker.page-regions-yolo
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: worker.page-regions-yolo
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: worker.page-regions-yolo
      spec:
        serviceAccountName: kimi-worker--page-regions-yolo
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: worker
          image: registry.gitlab.com/logius/nldoc/worker/page-regions-yolo:2.0.0
          imagePullPolicy: IfNotPresent
          env:
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: S3_REGION
            value: us-east-1
          - name: S3_HOST
            value: minio
          - name: S3_PORT
            value: "9000"
          - name: S3_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: minio-credentials
                key: rootUser
          - name: S3_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: minio-credentials
                key: rootPassword
          - name: S3_USE_SSL
            value: "false"
          - name: S3_SCHEME
            value: http
          - name: S3_FORCE_PATH_STYLE
            value: "true"
          - name: POSTGRESQL_USERNAME
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRESQL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          resources:
            requests:
              cpu: 300m
              memory: 1Gi
            limits:
              cpu: "1"
              memory: 2Gi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Worker: page-content-images
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-worker-page-content-images
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: worker.page-content-images
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: worker.page-content-images
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: worker.page-content-images
      spec:
        serviceAccountName: kimi-worker--page-content-images
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: worker
          image: registry.gitlab.com/logius/nldoc/worker/page-content-images:4.0.0
          imagePullPolicy: IfNotPresent
          env:
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: S3_REGION
            value: us-east-1
          - name: S3_HOST
            value: minio
          - name: S3_PORT
            value: "9000"
          - name: S3_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: minio-credentials
                key: rootUser
          - name: S3_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: minio-credentials
                key: rootPassword
          - name: S3_USE_SSL
            value: "false"
          - name: S3_SCHEME
            value: http
          - name: S3_FORCE_PATH_STYLE
            value: "true"
          - name: POSTGRESQL_USERNAME
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRESQL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 150m
              memory: 192Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Station: pdf-page-pageimage (for PDF pages  produces pageImage)
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-station-pdf-page-pageimage
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: station.pdf.page-pageimage
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: station.pdf.page-pageimage
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: station.pdf.page-pageimage
      spec:
        serviceAccountName: kimi-station--page-image
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: station
          image: registry.gitlab.com/logius/nldoc/worker/stations:13.0.1
          imagePullPolicy: IfNotPresent
          env:
          - name: NODE_TLS_REJECT_UNAUTHORIZED
            value: "0"
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: STATION_CONFIGURATION
            value: |
              {"input":{"parentType":"pdf","type":"page"},"output":{"attribute":{"name":"pageImage","type":"file"},"type":"attribute"},"workerResult":"fileWorkerResult"}
          - name: POSTGRES_HOST
            value: nldoc-postgres.nldoc.svc.cluster.local
          - name: POSTGRES_PORT
            value: "5432"
          - name: POSTGRES_DB
            value: nldoc
          - name: POSTGRES_USER
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          - name: POSTGRES_SCHEMA
            value: public
          - name: POSTGRES_SSL
            value: require
          - name: PGSSLMODE
            value: require
          - name: POSTGRES_POOL_SIZE
            value: "20"
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 150m
              memory: 192Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Station: pdf-page-regions (for PDF pages  produces regions)
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-station-pdf-page-regions
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: station.pdf.page-regions
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: station.pdf.page-regions
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: station.pdf.page-regions
      spec:
        serviceAccountName: kimi-station--page-regions
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: station
          image: registry.gitlab.com/logius/nldoc/worker/stations:13.0.1
          imagePullPolicy: IfNotPresent
          env:
          - name: NODE_TLS_REJECT_UNAUTHORIZED
            value: "0"
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: STATION_CONFIGURATION
            value: |
              {"input":{"parentType":"pdf","type":"page","requiredAttributes":[{"behavior":"await_all","name":"pageImage"}]},"output":{"attribute":{"name":"regions","type":"array"},"type":"attribute"},"workerResult":"fileWorkerResult"}
          - name: POSTGRES_HOST
            value: nldoc-postgres.nldoc.svc.cluster.local
          - name: POSTGRES_PORT
            value: "5432"
          - name: POSTGRES_DB
            value: nldoc
          - name: POSTGRES_USER
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          - name: POSTGRES_SCHEMA
            value: public
          - name: POSTGRES_SSL
            value: require
          - name: PGSSLMODE
            value: require
          - name: POSTGRES_POOL_SIZE
            value: "20"
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 150m
              memory: 192Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Station: pdf-page-content (for PDF pages  produces content)
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-station-pdf-page-content
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: station.pdf.page-content
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: station.pdf.page-content
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: station.pdf.page-content
      spec:
        serviceAccountName: kimi-station--page-content
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: station
          image: registry.gitlab.com/logius/nldoc/worker/stations:13.0.1
          imagePullPolicy: IfNotPresent
          env:
          - name: NODE_TLS_REJECT_UNAUTHORIZED
            value: "0"
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: STATION_CONFIGURATION
            value: |
              {"input":{"parentType":"pdf","requiredAttributes":[{"behavior":"await_all","name":"pageImage"},{"behavior":"await_all","name":"interpretedContent"},{"behavior":"await_all","name":"regions"}],"type":"page"},"output":{"attribute":{"name":"content","type":"array"},"type":"attribute"},"workerResult":"fileWorkerResult"}
          - name: POSTGRES_HOST
            value: nldoc-postgres.nldoc.svc.cluster.local
          - name: POSTGRES_PORT
            value: "5432"
          - name: POSTGRES_DB
            value: nldoc
          - name: POSTGRES_USER
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          - name: POSTGRES_SCHEMA
            value: public
          - name: POSTGRES_SSL
            value: require
          - name: PGSSLMODE
            value: require
          - name: POSTGRES_POOL_SIZE
            value: "20"
          - name: POSTGRESQL_USERNAME
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRESQL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 150m
              memory: 192Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Station: pdf-page-interpreted-content (for PDF pages  produces interpretedContent)
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-station-pdf-page-interpreted-content
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: station.pdf.page-interpretedcontent
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: station.pdf.page-interpretedcontent
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: station.pdf.page-interpretedcontent
      spec:
        serviceAccountName: kimi-station--page-content
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: station
          image: registry.gitlab.com/logius/nldoc/worker/stations:13.0.1
          imagePullPolicy: IfNotPresent
          env:
          - name: NODE_TLS_REJECT_UNAUTHORIZED
            value: "0"
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: STATION_CONFIGURATION
            value: |
              {"input":{"parentType":"pdf","requiredAttributes":[{"behavior":"await_all","name":"pageImage"}],"type":"page"},"output":{"attribute":{"name":"interpretedContent","type":"array"},"type":"attribute"},"workerResult":"fileWorkerResult"}
          - name: POSTGRES_HOST
            value: nldoc-postgres.nldoc.svc.cluster.local
          - name: POSTGRES_PORT
            value: "5432"
          - name: POSTGRES_DB
            value: nldoc
          - name: POSTGRES_USER
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          - name: POSTGRES_SCHEMA
            value: public
          - name: POSTGRES_SSL
            value: require
          - name: PGSSLMODE
            value: require
          - name: POSTGRES_POOL_SIZE
            value: "20"
          - name: POSTGRESQL_USERNAME
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRESQL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 150m
              memory: 192Mi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Worker: page-interpreted-content-ocr
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-worker-page-interpreted-content-ocr
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: worker.page-interpreted-content-ocr
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: worker.page-interpreted-content-ocr
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: worker.page-interpreted-content-ocr
      spec:
        serviceAccountName: kimi-worker--page-interpreted-content-ocr
        automountServiceAccountToken: false
        securityContext:
          fsGroup: 1001
          fsGroupChangePolicy: Always
        containers:
        - name: worker
          image: registry.gitlab.com/logius/nldoc/worker/page-interpreted-content-ocr:3.0.0
          imagePullPolicy: IfNotPresent
          env:
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USER
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASS
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          - name: S3_REGION
            value: us-east-1
          - name: S3_HOST
            value: minio
          - name: S3_PORT
            value: "9000"
          - name: S3_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: minio-credentials
                key: rootUser
          - name: S3_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: minio-credentials
                key: rootPassword
          - name: S3_USE_SSL
            value: "false"
          - name: S3_SCHEME
            value: http
          - name: S3_FORCE_PATH_STYLE
            value: "true"
          - name: POSTGRESQL_USERNAME
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: username
          - name: POSTGRESQL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: nldoc.nldoc-postgres.credentials.postgresql.acid.zalan.do
                key: password
          resources:
            requests:
              cpu: 1
              memory: 4Gi
            limits:
              cpu: 2
              memory: 8Gi
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
          volumeMounts:
          - name: tmp
            mountPath: /tmp
            subPath: tmp-dir
        volumes:
        - name: tmp
          emptyDir: {}

# Page Worker Adapter - Routes pdf.page-* jobs to folio.page-* workers
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: kimi-page-worker-adapter
    labels:
      app.kubernetes.io/name: kimi
      app.kubernetes.io/instance: kimi
      app.kubernetes.io/component: adapter.page-worker
  spec:
    replicas: 1
    selector:
      matchLabels:
        app.kubernetes.io/name: kimi
        app.kubernetes.io/instance: kimi
        app.kubernetes.io/component: adapter.page-worker
    template:
      metadata:
        labels:
          app.kubernetes.io/name: kimi
          app.kubernetes.io/instance: kimi
          app.kubernetes.io/component: adapter.page-worker
      spec:
        containers:
        - name: adapter
          image: ghcr.io/conductionnl/nldoc-page-worker-adapter:latest
          imagePullPolicy: Always
          env:
          - name: AMQP_HOST
            value: rabbitmq.nldoc.svc.cluster.local
          - name: AMQP_PROTOCOL
            value: amqp
          - name: AMQP_PORT
            value: "5672"
          - name: AMQP_USERNAME
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: username
          - name: AMQP_PASSWORD
            valueFrom:
              secretKeyRef:
                name: rabbitmq-default-user
                key: password
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi

